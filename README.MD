
SERVER SETUP  =========================================================================================================================

How to download, install OpenVPN Access server:

Download and Install OpenVPN full package from here:  https://openvpn.net/vpn-software-packages/
Identify a machine on your network as the DMZ and configure it as such using that network's router

Follow installation instructions to set up OpenVPN on DMZ server
Use this guideline for Distiguished Name (DN) definition:
Notes:
For extra security beyond that provided by SSL/TLS, create an "HMAC firewall" to help block DoS attacks and UDP port flooding.

Generate with:
 openvpn --genkey --secret ta.key

The server and each client must have a copy of this key.
The second parameter should be '0' on the server and '1' on the clients.
tls-auth ta.key 0 # This file is secret

export KEY_COUNTRY="US"
export KEY_PROVINCE="AZ"
export KEY_CITY="Tucson"
export KEY_ORG="GBCInc"
export KEY_EMAIL="techsupport@onlinegbc.com"
export KEY_CN=onlinegbc.com
export KEY_ALTNAMES=funauto.com
export KEY_NAME=GBCInc
export KEY_OU=FUNAuto

Identify server files:
    /etc/openvpn/ca.crt
    /etc/openvpn/easy-rsa/keys/client-certificate.crt
    /etc/openvpn/easy-rsa/keys/client-certificate.key 
to /etc/openvpn
Set up Google 2FA (not easy--done by Vitaly Volkov on Upwork)


How to start/stop openvpn server?
sudo systemctl restart/start/stop/status openvpn
openvpn is installed in /etc/openvpn on server

There is a bug (https://bugzilla.redhat.com/show_bug.cgi?id=1435831) as a result of which OpenVPN server does not start on reboot.  To fix this, we must manually "sudo mkdir /run/openvpn" after the system has started.  Else, put this in a batch script sowmehere, later
In server.conf, enter this line:
remote-cert-tls client
In client.conf, enter this line:
remote-cert-tls server


Create a new user for VPN or activate 2FA for an existing user:
 - For a new user, run "useradd <username>" to create a user account. OpenVPN uses system login database (/etc/passwd) for verifying clients credentials.  Then, run "passwd <username>" to set the password for the new user.
 - As user <username>, run "su -c "google-authenticator -t -d -r3 -R30 -f -l /"OpenVPN/" -s /etc/openvpn/google-authenticator/funauto" - usr-gauth" to create a Google Authenticator token for a new user. The token ID must be passed to the user so that they could add it on the Google Authenticator app installed on their smartphone.
 - To connect to the OpenVPN server the user must provide their login name, their password and a one-time code generated by 
 Google Authenticator. Since the feature of passing the code to the server isn't supported by OpenVPN clients, the code can 
 be included in the password field following the password. For instance, if the user's password is "ovpn-pass"  and the code 
 is "123456", then the user must put "ovpn-pass123456" in the password field.
	su -c "<command>" - usr-gauth - The command is being run in context of "usr-gauth" user because he has the necessary rights to /etc/openvpn/google-authenticator folder

Parameters for google-authenticator - the script that generates tokens:
		-t - use time-based authentication
		-d - disallow reuse of the same code
		-r3 R30 - limit logins to 3 per every 30 seconds
		-f - write token key and settings without first confirming with user
		-s - location where the token file for the <username> will be put. We use /etc/openvpn/google-authenticator.
The token ID must be passed to the user so that they could add it on the Google Authenticator app installed on their smartphone. 


CLIENT SETUP  =========================================================================================================================
LINUX:
How to download, install, start and stop Openvpn client

Download and Install OpenVPN full package from here:  https://openvpn.net/vpn-software-packages/

Copy server files:
    /etc/openvpn/ca.crt
    /etc/openvpn/easy-rsa/keys/client-certificate.crt
    /etc/openvpn/easy-rsa/keys/client-certificate.key 
to /etc/openvpn

In server.conf, enter this line:
remote-cert-tls client
In client.conf, enter this line:
remote-cert-tls server


sudo openvpn --config ./client.conf
Will prompt for user ID and pswd (vpn-user, openvpn w 2FA string added)

WINDOWS:
Download and Install OpenVPN full package from here: https://openvpn.net/downloads/openvpn-connect-v2-windows.msi
Copy server files: ca.crt, client-certificate.crt client-certificate.key to openvpn in Windows
In client.ovpn, enter this line: remote-cert-tls server
Start OpenVPN and enter path to client

